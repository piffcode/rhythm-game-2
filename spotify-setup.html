<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Game - Setup Spotify</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; color: white; }
        .setup-container { background: rgba(0, 0, 0, 0.8); padding: 40px; border-radius: 20px; text-align: center; max-width: 500px; width: 100%; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5); }
        .logo { font-size: 2.5em; color: #1db954; margin-bottom: 20px; }
        h1 { margin-bottom: 20px; font-size: 1.8em; }
        .instructions { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; line-height: 1.6; text-align: left; }
        .instructions ol { margin-left: 20px; }
        .instructions li { margin-bottom: 10px; }
        .spotify-btn { background: #1db954; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 25px; cursor: pointer; text-decoration: none; display: inline-block; font-weight: bold; transition: all 0.3s ease; margin-bottom: 20px; min-width: 200px; }
        .spotify-btn:hover { background: #1ed760; transform: translateY(-2px); }
        .secondary-btn { background: rgba(255,255,255,0.2); border: 1px solid #fff; }
        .status-message { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin: 10px 0; display: none; }
        .status-message.success { background: rgba(29, 185, 84, 0.2); border-left: 4px solid #1db954; }
        .status-message.warning { background: rgba(255, 193, 7, 0.2); border-left: 4px solid #ffc107; color: #ffc107; }
        .spinner { border: 3px solid rgba(29, 185, 84, 0.3); border-top: 3px solid #1db954; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        #troubleshooting { text-align: left; font-size: 0.9em; color: #b3b3b3; line-height: 1.5; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="logo">ðŸŽµ</div>
        <h1>Setup Spotify Playback</h1>
        <div id="initial-prompt">
            <div class="instructions">
                <ol>
                    <li>Click the button below to open your Spotify app.</li>
                    <li>Play any song briefly to activate your device.</li>
                    <li>Return to this page. We'll handle the rest!</li>
                </ol>
            </div>
            <button id="open-spotify-btn" class="spotify-btn">Open Spotify App</button>
        </div>
        <div id="polling-status">
            <div class="spinner" id="spinner"></div>
            <div id="status-message" class="status-message"></div>
        </div>
        <div id="troubleshooting">
            <h4>Setup Timed Out</h4>
            <p>We couldn't find an active Spotify device. Please ensure:</p>
            <ul>
                <li>The Spotify app is installed and running.</li>
                <li>You are logged into the same account you used to sign in.</li>
                <li>You have an active internet connection.</li>
            </ul>
            <button id="retry-btn" class="spotify-btn secondary-btn">Retry Detection</button>
        </div>
    </div>

    <script type="module">
        import { CONFIG } from './config.js';

        const spinner = document.getElementById('spinner');
        const statusMessage = document.getElementById('status-message');
        const openSpotifyBtn = document.getElementById('open-spotify-btn');
        const retryBtn = document.getElementById('retry-btn');
        const initialPrompt = document.getElementById('initial-prompt');
        const troubleshooting = document.getElementById('troubleshooting');

        let pollInterval;
        let timeout;

        function showStatus(message, type = 'warning') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
        }

        async function getAccessToken() {
            const token = sessionStorage.getItem('access_token');
            const expiresAt = sessionStorage.getItem('expires_at');
            if (token && expiresAt && Date.now() < parseInt(expiresAt)) {
                return token;
            }
            // More complex refresh logic is in rhythm.js; this page assumes a fresh, valid token.
            // If token is expired, we should be redirected back to auth.
            showStatus('Session expired. Please sign in again.', 'error');
            setTimeout(() => window.location.href = './auth.html', 3000);
            return null;
        }

        async function spotifyApi(endpoint, options = {}) {
            const token = await getAccessToken();
            if (!token) throw new Error("No valid token");
            const response = await fetch(`https://api.spotify.com/v1${endpoint}`, {
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', ...options.headers },
                ...options
            });
            if (!response.ok) {
                 const errorData = await response.json().catch(() => ({}));
                 throw new Error(errorData.error?.message || `HTTP ${response.status}`);
            }
            if (response.status === 204) return null;
            return response.json();
        }

        function openSpotifyApp() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent);
            window.location.href = isMobile ? 'spotify://' : 'spotify:';
            setTimeout(() => {
                // If the user is still on this page after a moment, the app likely didn't open.
                // This is an imperfect check.
                if (document.hidden === false) {
                     showStatus('If the app did not open, please open it manually.', 'warning');
                }
            }, 2000);
        }

        async function startPolling() {
            initialPrompt.style.display = 'none';
            troubleshooting.style.display = 'none';
            spinner.style.display = 'block';
            showStatus('Looking for an active Spotify device...', 'info');

            pollInterval = setInterval(async () => {
                try {
                    const data = await spotifyApi('/me/player/devices');
                    const activeDevice = data.devices.find(d => d.is_active);
                    if (activeDevice) {
                        console.log('Active device found!', activeDevice);
                        clearInterval(pollInterval);
                        clearTimeout(timeout);
                        await completeSetup(activeDevice.id);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 5000);

            timeout = setTimeout(() => {
                clearInterval(pollInterval);
                spinner.style.display = 'none';
                showStatus('Setup timed out. Please try again.', 'error');
                troubleshooting.style.display = 'block';
            }, 60000);
        }
        
        async function completeSetup(deviceId) {
            try {
                spinner.style.display = 'block';
                showStatus('Device found! Finalizing setup...', 'success');

                await spotifyApi('/me/player', {
                    method: 'PUT',
                    body: JSON.stringify({ device_ids: [deviceId] }),
                });

                sessionStorage.setItem('setup_device_id', deviceId);

                const urlParams = new URLSearchParams(window.location.search);
                const nextUrl = new URL(CONFIG.NEXT_URL);
                nextUrl.searchParams.set('setup_complete', 'true');
                if(urlParams.get('bootstrap')) nextUrl.searchParams.set('bootstrap', urlParams.get('bootstrap'));
                if(urlParams.get('country')) nextUrl.searchParams.set('country', urlParams.get('country'));

                window.location.href = nextUrl.toString();
            } catch (error) {
                console.error('Final setup failed:', error);
                showStatus(`Setup failed: ${error.message}. Please retry.`, 'error');
                spinner.style.display = 'none';
                troubleshooting.style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (!sessionStorage.getItem('bootstrap_nonce') || sessionStorage.getItem('bootstrap_nonce') !== urlParams.get('bootstrap')) {
                showStatus('Invalid session. Redirecting to login...', 'error');
                setTimeout(() => window.location.href = './auth.html', 3000);
                return;
            }

            openSpotifyBtn.addEventListener('click', () => {
                openSpotifyApp();
                startPolling();
            });

            retryBtn.addEventListener('click', startPolling);

            // Immediately check for devices on load
            (async () => {
                 try {
                    const data = await spotifyApi('/me/player/devices');
                    if (data.devices.find(d => d.is_active)) {
                        console.log("Active device found on page load, starting setup immediately.");
                        startPolling();
                    }
                 } catch (e) {
                    console.error("Initial device check failed", e);
                 }
            })();
        });
    </script>
</body>
</html>